SET @org_partial_revokes= @@partial_revokes;
SET @org_sql_mode= @@sql_mode;
CREATE USER u1;
ALTER USER u1 COMMENT 'free form text';
SELECT user,user_attributes FROM mysql.user WHERE user='u1';
ALTER USER u1 COMMENT 'changed the free form text';
SELECT user,user_attributes FROM mysql.user WHERE user='u1';
ALTER USER u1 ATTRIBUTE '{"uid" : "34234"}';
SELECT user,user_attributes FROM mysql.user WHERE user='u1';
ALTER USER u1 ATTRIBUTE '{"speed" : "9000"}';
SELECT user,user_attributes FROM mysql.user WHERE user='u1';
ALTER USER u1 ATTRIBUTE '{"speed" : null }';
SELECT user,user_attributes FROM mysql.user WHERE user='u1';
SELECT user_attributes->>"$.metadata.speed" FROM mysql.user WHERE user= 'u1';
CREATE USER foo@localhost IDENTIFIED BY 'foo' FAILED_LOGIN_ATTEMPTS 4 PASSWORD_LOCK_TIME 6;
ALTER USER foo@localhost COMMENT 'password lock time';
SELECT user_attributes->>"$.metadata" FROM mysql.user WHERE user='foo';
ALTER USER foo@localhost ATTRIBUTE '{"flag":"red"}';
SELECT user_attributes FROM mysql.user WHERE user='foo';
ALTER USER foo@localhost ATTRIBUTE '{"flag":null}';
SELECT user_attributes FROM mysql.user WHERE user='foo';

ALTER USER foo@localhost COMMENT 'zzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzz';
SELECT user_attributes FROM mysql.user WHERE user= 'foo';
ALTER USER foo@localhost COMMENT 'xxx';
ALTER USER foo@localhost ATTRIBUTE 'not a valid object';
ALTER USER foo@localhost ATTRIBUTE NULL;
ALTER USER foo@localhost ATTRIBUTE;
ALTER USER foo@localhost COMMENT;
ALTER USER u4@sdasd ATTRIBUTE '{}';
ALTER USER fff@asdasd COMMENT '';
ALTER USER USER() COMMENT 'test';

CREATE USER foo2@localhost IDENTIFIED BY 'foo' COMMENT 'xxx';
SELECT user,user_attributes FROM mysql.user WHERE user='foo2';
CREATE USER foo3 PASSWORD EXPIRE DEFAULT COMMENT 'abc';
CREATE USER foo4 ACCOUNT LOCK ATTRIBUTE '{"stuff":"ffuts"}';
ALTER USER foo4 ACCOUNT UNLOCK ATTRIBUTE '{"stuff":"unlocked"}';
SELECT user,user_attributes FROM mysql.user WHERE user like 'foo%';

SELECT * FROM INFORMATION_SCHEMA.USER_ATTRIBUTES WHERE USER like 'foo%';
SELECT `attribute`->>"$.comment" FROM INFORMATION_SCHEMA.USER_ATTRIBUTES WHERE USER like 'foo%';
SET GLOBAL partial_revokes=ON;
SELECT user, user_attributes FROM mysql.user WHERE user='foo';
ALTER USER foo@localhost ATTRIBUTE '{"key":"value"}';
ALTER USER foo@localhost COMMENT 'Added key/value pair';
SELECT user,user_attributes FROM mysql.user WHERE user='foo';
SELECT user,user_attributes FROM mysql.user WHERE user='foo';

CREATE USER redqueen@localhost IDENTIFIED BY 'shoo';
ALTER USER redqueen@localhost IDENTIFIED BY 'madness' RETAIN CURRENT PASSWORD;
SELECT user,char_length(user_attributes->>"$.additional_password") FROM mysql.user WHERE user='redqueen';
ALTER USER redqueen@localhost DISCARD OLD PASSWORD COMMENT 'Dropped old password';
SELECT user,char_length(user_attributes->>"$.additional_password") as length_password,user_attributes->>"$.metadata.comment" as comment FROM mysql.user WHERE user='redqueen';

SET GLOBAL partial_revokes=OFF;

DROP USER foo@localhost, u1, foo3, foo2@localhost, foo4, redqueen@localhost;
CREATE USER u1 COMMENT 'Hello "Smith"';
let $result=`SHOW CREATE USER u1`;
DROP USER u1;
DROP USER u1;
CREATE USER u1 COMMENT 'Hello "Smith"';
SET @@sql_mode='NO_BACKSLASH_ESCAPES';
let $result=`SHOW CREATE USER u1`;
DROP USER u1;
DROP USER u1;
SET @@sql_mode = @org_sql_mode;
CREATE USER u1@localhost IDENTIFIED BY 'foo' COMMENT 'Not permitted to change this';
ALTER USER u1@localhost COMMENT 'I comment what I want';
ALTER USER u1@localhost ATTRIBUTE '{"key": "value"}';
DROP USER u1@localhost;
CREATE USER u1@localhost IDENTIFIED BY 'foo',u2@localhost IDENTIFIED BY 'foo' COMMENT "Works with partial restrictions";
SET GLOBAL partial_revokes=ON;
SELECT user_attributes FROM mysql.user WHERE user='u1';
ALTER USER CURRENT_USER() COMMENT 'test';
SELECT user_attributes->>"$.metadata.comment" FROM mysql.user WHERE user='u2';
ALTER USER CURRENT_USER() ATTRIBUTE '{ "comment" : null }';
ALTER USER u1@localhost ATTRIBUTE '{"Restrictions": [{"Database":"mysql","Privileges": [ "CREATE" ]}]}';
SELECT user_attributes FROM mysql.user WHERE user='u1';

DROP USER u1@localhost, u2@localhost;
CREATE USER u1@localhost ATTRIBUTE "this is a string";
SET GLOBAL partial_revokes=@org_partial_revokes;
