drop table if exists t1,t2,t7,t8,t9;
drop database if exists mysqltest;

--
-- First create little data to play with
--

create table t1 (a int not null auto_increment, b char(16) not null, primary key (a)) engine=myisam;
create table t2 (a int not null auto_increment, b char(16) not null, primary key (a)) engine=myisam;
insert into t1 (b) values ("test"),("test1"),("test2"),("test3");
insert into t2 (b) select b from t1;
insert into t1 (b) select b from t2;
insert into t2 (b) select b from t1;
insert into t1 (b) select b from t2;
insert into t2 (b) select b from t1;
insert into t1 (b) select b from t2;
insert into t2 (b) select b from t1;
insert into t1 (b) select b from t2;
insert into t2 (b) select b from t1;
insert into t1 (b) select b from t2;
insert into t2 (b) select b from t1;
insert into t1 (b) select b from t2;
insert into t2 (b) select b from t1;
insert into t1 (b) select b from t2;
insert into t2 (b) select b from t1;
insert into t1 (b) select b from t2;
insert into t2 (b) select b from t1;
insert into t1 (b) select b from t2;
drop table t2;

--
-- Start the test
-- We use t9 here to not crash with tables generated by the backup test
-- 

--replace_result $MYSQLTEST_VARDIR MYSQLTEST_VARDIR
eval create table t9 (a int not null auto_increment, b char(16) not null, primary key (a)) 
engine=myisam data directory="$MYSQLTEST_VARDIR/tmp" index directory="$MYSQLTEST_VARDIR/run";

insert into t9 select * from t1;
alter table t9 add column c int not null;

-- Test renames
alter table t9 rename t8, add column d int not null;
alter table t8 rename t7;
drop table t1;

--
-- Test error handling
-- Note that we are using the above table t9 here!
--

--replace_result $MYSQLTEST_VARDIR MYSQLTEST_VARDIR
SHOW CREATE TABLE t9;


-- Check that we cannot link over a table from another database.

create database mysqltest;
create table mysqltest.t9 (a int not null auto_increment, b char(16) not null, primary key (a)) 
engine=myisam index directory="/this-dir-does-not-exist";
create table mysqltest.t9 (a int not null auto_increment, b char(16) not null, primary key (a)) 
engine=myisam index directory="not-hard-path";

-- Should fail becasue the file t9.MYI already exist in 'run'
--replace_result $MYSQLTEST_VARDIR MYSQLTEST_VARDIR
--error 1,1,ER_UNKNOWN_ERROR
eval create table mysqltest.t9 (a int not null auto_increment, b char(16) not null, primary key (a)) 
engine=myisam index directory="$MYSQLTEST_VARDIR/run";

-- Should fail becasue the file t9.MYD already exist in 'tmp'
--replace_result $MYSQLTEST_VARDIR MYSQLTEST_VARDIR
--error 1,1
eval create table mysqltest.t9 (a int not null auto_increment, b char(16) not null, primary key (a)) 
engine=myisam data directory="$MYSQLTEST_VARDIR/tmp";

-- Check moving table t9 from default database to mysqltest;

alter table t9 rename mysqltest.t9;
select count(*) from mysqltest.t9;
drop database mysqltest;

--
-- Test changing data dir (Bug #1662)
--

create table t1 (a int not null) engine=myisam;
alter table t1 add b int;
drop table t1;

--
-- BUG#32111 - Security Breach via DATA/INDEX DIRECORY and RENAME TABLE
--
--write_file $MYSQLTEST_VARDIR/tmp/t1.MYI
EOF

--replace_result $MYSQLTEST_VARDIR TEST_DIR $MYSQLTEST_VARDIR TEST_DIR
--error 1,1
eval CREATE TABLE t1(a INT) ENGINE = MYISAM
DATA DIRECTORY='$MYSQLTEST_VARDIR/tmp'
INDEX DIRECTORY='$MYSQLTEST_VARDIR/tmp';
DROP TABLE t2;

--
-- Bug#8706 - temporary table with data directory option fails
--
connect (session1,localhost,root,,);
create table t1 (a int) engine=myisam select 42 a;
select * from t1;
select * from t1;
select * from t1;
drop table t1;

--
-- Bug #29325: create table overwrites .MYD file of other table (datadir)
--
let $MYSQLD_DATADIR= `select @@datadir`;
SET SESSION keep_files_on_create = TRUE;
EOF
--disable_abort_on_error
--error 1,1,ER_TABLE_EXISTS_ERROR
CREATE TABLE t1 (a INT) ENGINE MYISAM;
SET SESSION keep_files_on_create = FALSE;
CREATE TABLE t1 (a INT) ENGINE MYISAM;
DROP TABLE t1;

--
-- Bug#32167: another privilege bypass with DATA/INDEX DIRECTORY
--
-- With Bug#41002 (symlink.test fails on symlinked datadir) it was
-- decided that the below statements may also succeed if the data
-- home directory is symlinked, e.g. mysql-test-run --mem.
-- This will be fixed in 6.0 only.
--
let $MYSQLD_DATADIR= `select @@datadir`;
DROP TABLE IF EXISTS t1;
DROP TABLE IF EXISTS t1;
DROP TABLE IF EXISTS t1;
DROP TABLE IF EXISTS t1;

--
-- BUG#25677 - With --skip-symbolic-links option on, DATA DIRECTORY clause is
--             silently ignored
--

SET @OLD_SQL_MODE=@@SQL_MODE, @@SQL_MODE='NO_DIR_IN_CREATE';
DROP TABLE t1;
SET @@SQL_MODE=@OLD_SQL_MODE;
CREATE SCHEMA schema1;
CREATE TABLE schema1.t1 (a INT, b INT) ENGINE=MYISAM;
INSERT INTO schema1.t1 VALUES(1,1);
INSERT INTO schema1.t1 VALUES(2,2);
                            INDEX DIRECTORY='$MYSQL_TMP_DIR/mysql';
DROP TABLE t1;
SELECT * FROM schema1.t1;
DROP SCHEMA schema1;
drop table if exists t1, t2;
      data directory="$MYSQLTEST_VARDIR/tmp"
      index directory="$MYSQLTEST_VARDIR/run";
create table t2 like t1;
drop tables t1, t2;
CREATE DATABASE x;
USE x;
DROP DATABASE x;

DROP TABLE test.t1;
